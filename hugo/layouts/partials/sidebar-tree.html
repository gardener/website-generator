{{/* We cache this partial for bigger sites and set the active class client side. */}}
{{ $sidebarCacheLimit := cond (isset .Site.Params.ui "sidebar_cache_limit") .Site.Params.ui.sidebar_cache_limit 2000 }}
{{ $shouldDelayActive := ge (len .Site.Pages) $sidebarCacheLimit }}

{{$catMap := dict}}
{{/* Custom cascade with merge instead of override*/}}
{{ range sort .Site.Pages ".Permalink" "asc" }}
  {{ $propagatedCategories := .Params.categories }}
  {{ $permalink := .Permalink}}
  {{/* Iterate catMap and search for parent node(current Permalink begins with interated Permalink) */}}
  {{/* Merge propagated categories with parents categories */}}
  {{ range $parentPermalink,$parentCategories := $catMap }}
    {{ if hasPrefix $permalink $parentPermalink}}
      {{ $propagatedCategories = union $parentCategories $propagatedCategories }}
    {{ end }}
  {{ end }}
  {{$catMap = merge $catMap (dict .Permalink $propagatedCategories)}}
{{ end }}
{{/* Bottom up parent category merge*/}}
{{ range sort .Site.Pages ".Permalink" "desc" }}
  {{if .Parent}}
    {{ $parentPath := .Parent.Permalink}}
    {{$catMap = merge $catMap (dict $parentPath (union (index $catMap $parentPath) (index $catMap .Permalink) )) }}
  {{end}}
{{end}}

<div id="td-sidebar-menu" class="td-sidebar__inner{{ if $shouldDelayActive }} d-none{{ end }}">
  {{ if not .Site.Params.ui.sidebar_search_disable }}
  <form class="td-sidebar__search d-flex align-items-center">
    {{ partial "search-input.html" . }}
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  {{ else }}
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">
    {{ partial "search-input.html" . }}
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  {{ end }}
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    {{ if  (gt (len .Site.Home.Translations) 0) }}
    <div class="nav-item dropdown d-block d-lg-none">
      {{ partial "navbar-lang-selector.html" . }}
    </div>
    {{ end }}
    {{ $navRoot := cond (and (ne .Params.toc_root true) (eq .Site.Home.Type "docs")) .Site.Home .FirstSection }}
    {{ $ulNr := 0 }}
    {{ $ulShow := cond (isset .Site.Params.ui "ul_show") .Site.Params.ui.ul_show 1 }}
    {{ $sidebarMenuTruncate := cond (isset .Site.Params.ui "sidebar_menu_truncate") .Site.Params.ui.sidebar_menu_truncate 50 }}
    <ul class="td-sidebar-nav__section pr-md-3 ul-{{ $ulNr }}">
      {{ template "section-tree-nav-section" (dict "computedMap" $catMap "page" . "section" $navRoot "shouldDelayActive" $shouldDelayActive "sidebarMenuTruncate" $sidebarMenuTruncate "ulNr" $ulNr "ulShow" (add $ulShow 1)) }}
    </ul>
  </nav>
</div>
      
{{ define "section-tree-nav-section" }}
  {{ $catMapPar := .computedMap}}

  {{ $s := .section }}
  {{ $p := .page }}
  {{ $shouldDelayActive := .shouldDelayActive }}
  {{ $sidebarMenuTruncate := .sidebarMenuTruncate }}
  {{ $treeRoot := cond (eq .ulNr 0) true false }}
  {{ $ulNr := .ulNr }}
  {{ $ulShow := .ulShow }}
  {{ $active := and (not $shouldDelayActive) (eq $s $p) }}
  {{ $activePath := and (not $shouldDelayActive) ($p.IsDescendant $s) }}
  {{ $show := cond (or (lt $ulNr $ulShow) $activePath (and (not $shouldDelayActive) (eq $s.Parent $p.Parent)) (and (not $shouldDelayActive) (eq $s.Parent $p)) (not $p.Site.Params.ui.sidebar_menu_compact) (and (not $shouldDelayActive) ($p.IsDescendant $s.Parent))) true false }}
  {{ $mid := printf "m-%s" ($s.RelPermalink | anchorize) }}
  {{ $pages_tmp := where (union $s.Pages $s.Sections).ByWeight ".Params.toc_hide" "!=" true }}
  {{ $pages := $pages_tmp | first $sidebarMenuTruncate }}
  {{ $withChild := gt (len $pages) 0 }}
  {{ $manualLink := cond (isset $s.Params "manuallink") $s.Params.manualLink ( cond (isset $s.Params "manuallinkrelref") (relref $s $s.Params.manualLinkRelref) $s.RelPermalink) }}
  {{ $manualLinkTitle := cond (isset $s.Params "manuallinktitle") $s.Params.manualLinkTitle $s.Title }}
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section{{ if $withChild }} with-child{{ else }} without-child{{ end }}{{ if $activePath }} active-path{{ end }}{{ if not $show }} collapse{{ end }}" id="{{ $mid }}-li">
    {{range index $catMapPar $s.Permalink}}
      <span class="category-label">{{ . }}</span>
    {{end}}    
    <a href="{{ $manualLink }}"{{ if ne $s.LinkTitle $manualLinkTitle }} title="{{ $manualLinkTitle }}"{{ end }}{{ with $s.Params.manualLinkTarget }} target="{{ . }}"{{ if eq . "_blank" }} rel="noopener"{{ end }}{{ end }} class="align-left pl-0 pr-2{{ if $active}} active{{ end }} td-sidebar-link{{ if $s.IsPage }} td-sidebar-link__page{{ else }} td-sidebar-link__section{{ end }}{{ if $treeRoot }} tree-root{{ end }}" id="{{ $mid }}">{{ with $s.Params.Icon}}<i class="{{ . }}"></i>{{ end }}<span class="{{ if $active }}td-sidebar-nav-active-item{{ end }}">{{ $s.LinkTitle }}</span></a>
    {{if $withChild }}
      {{ $ulNr := add $ulNr 1 }}
      <ul class="pr-md-3 ul-{{ $ulNr }}">
        {{ range $pages }}
          {{ if (not (and (eq $s $p.Site.Home) (eq .Params.toc_root true))) }}
            {{ template "section-tree-nav-section" (dict "computedMap" $catMapPar  "page" $p "section" . "shouldDelayActive" $shouldDelayActive "sidebarMenuTruncate" $sidebarMenuTruncate "ulNr" $ulNr "ulShow" $ulShow) }}
          {{ end }}
        {{ end }}
      </ul>
    {{ end }}
  </li>
{{ end }}
<style>
    .category-label{
        display: inline;
        color:orange;
        display: none;
    }
    .irrelevant-topic{
        display: none;
    }
</style>
<script>
    const selectedRole = window.sessionStorage.getItem("role_selected")
    if(selectedRole && selectedRole!="All"){
        const nav = document.querySelector("#td-section-nav > ul > li > ul")
        const navItems = nav.querySelectorAll("li")
        navItems.forEach(item => item.setAttribute("class",item.getAttribute("class")+" irrelevant-topic"))
        navItems.forEach(item => {
            const labels = Array.from(item.querySelectorAll(":scope > .category-label"))
            if (labels.length ==0 || labels.filter(role => role.innerHTML == selectedRole).length > 0){
                item.setAttribute("class",item.getAttribute("class").replace("irrelevant-topic",""))
            }
        })
    }
</script>